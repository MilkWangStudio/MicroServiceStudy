- [软件项目架构方案演进](#软件项目架构方案演进)
  - [小徐的创业史](#小徐的创业史)
    - [阶段一: 单体应用](#阶段一-单体应用)
      - [前后端分离](#前后端分离)
    - [阶段二：分布式-垂直拆分](#阶段二分布式-垂直拆分)
    - [阶段三：分布式-微服务](#阶段三分布式-微服务)

# 软件项目架构方案演进
大家提到项目架构的时候，脑海里会想到什么？  
一般脑海里可能会立刻冒出一些词：前后端分离、MVC、单体应用、分布式、微服务。  
我在网上搜了一下架构方案，还有一堆接触比较少的技术名词：DDD、SOA、ServiceMesh、Serverless、云原生。  

其实这些都是架构方案，只是讨论的角度不太一样，对上面这些方案简单做一下划分，帮助大家理解。  
- 架构风格：单体应用、分布式、微服务
- 代码分层：前后端分离、MVC、DDD
- 运维方案：ServiceMesh、Serverless
- 特殊：云原生

云原生比较特殊，它其实指一堆概念、落地方案的聚合，包括容器化、微服务、devops等，属于是提供了一个云上的最佳实践，每家云厂商都在做，当然具体实现标准就各有差异了。  

本章将以 _**架构风格**_ 的演进为主线，理清为什么会有这么多架构方案，他们又都解决了什么问题。  

## 小徐的创业史
我们假设有一个叫小徐的同学，他在互联网初期用Java创建了一个叫“MikuFans”的视频网站。  
### 阶段一: 单体应用
![alt 单体应用](http://assets.processon.com/chart_image/6350b39b1efad4167899b0b1.png)  

用户的请求经过代理后会打到某一台机器上，然后从JSP模板引擎拿到HTML渲染页面。  
#### 前后端分离
因为只有小徐一个人开发，所以前后端是模板引擎的合作方式。无论是页面、接口修改，都在一个项目里处理掉了，一个访问首页的接口大概是这样：

```API
GET /home.html
Response: 
<div v-for="{{Video in VideoList}}">
    <VideoComponent data={{Video}}/>
</div>
```
![模板引擎页面渲染流程](http://assets.processon.com/chart_image/6350fb3f7d9c08074760f067.png)


小徐开发的很开心，有什么功能先后端在一个项目里，一梭子就搞完了。后来小徐招了一个前端来帮他分担工作。这位前端小伙伴只会写JS，不会Java。没法改Java项目里的模板页面。    

经过沟通后他们决定前端小伙先写静态页面，写完之后把代码发给小徐，然后小徐把页面代码改成JSP模板引擎的语法。  

![模板引擎工作方式](http://assets.processon.com/chart_image/6350fb121efad416789afc18.png)  

两个人开发迭代果然快很多，网站用户变多了，又开始扩充团队。这时候小徐开始忙不过来了，前端想改个颜色都得让小徐重新发布后端项目。小徐总结了下这种视图层和接口层混在一起的方案有这么几个问题：
- 前后端职责不清晰，比如一些条件渲染、循环渲染，是js写还是java写？
- 页面样式会频繁修改发版，但是后端服务希望越少发版越好，最好一周上线一次
- 用户打开页面需要等后台数据查询完成，页面白屏时间比较长。
- 对于线上出现的展示问题，前端无法单独排障，因为前端开发的是没有动态数据的静态页面

这时候开始尝试把前端项目单独部署，小徐在线上给前端团队开了一台服务器，页面请求会被路由到这台服务器上，浏览器打开后再通过HTTP请求查询后台服务。整个请求的链路大概是这样的：  

![页面加载流程-前后端分离](http://assets.processon.com/chart_image/6350ec15e401fd06f77292da.png)  

改造后前端团队效率高了很多，带来了这些好处：  
- 前端可以自己修改页面逻辑、发版
- 后端开发只需要关注业务逻辑
- 首屏加载变快，甚至可以做一些骨架屏的视觉效果
- 前端开发的就是线上展示的，甚至可以写前端的单元测试了

但是同样，引入新的解决方案，总会带来一些新的问题，前后端分离后会有这些影响：
- 许多逻辑被放在前端处理，前端开发的能力要求提高
- CICD需要针对前端技术栈调整发布流程
- 渲染一个页面需要的接口变多了，后端服务压力增加

但总的来说前后端分离彻底奠定了前后端开发岗位的职责区分，并且给了前端开发岗位足够的技术上限。  

### 阶段二：分布式-垂直拆分
随着功能迭代，产品模块越来越多，代码糅杂在一个项目里，牵一发动全身，每次上线回归测试都要测很久。而且热点业务大量的流量会占用性能资源，一些核心功能都会受影响，比如登录。  

因此小徐开始了第二轮的架构优化，从功能模块来拆分，比如音视频模块、用户模块、评论模块等，每个模块独立部署，内部完成这个模块的业务逻辑，相互之间没有调用。  

![分布式-垂直拆分](http://assets.processon.com/chart_image/63510e6ee0b34d40be79dccb.png)  

从这个图中能看到，页面不同功能请求会路由到不通的服务。这种分布式服务的拆分有以下优点：  
- 从单体应用做架构升级成本低，各模块本质还是单体应用的开发方式
- 代码做了切分，维护成本降低，各模块项目可独立修改、上下线
- 可针对不同模块的流量压力调整部署资源


经过拆分后，技术团队小伙伴分成了不同业务线，大家各自维护自己的模块项目，开发效率大大提升。

### 阶段三：分布式-微服务
产品经过垂直拆分后，线上的分布式服务撑起了很高的并发，但是随着业务逻辑越来越复杂，每个模块都糅杂了一堆其他模块的逻辑代码。改也不敢改，只能在屎山上继续堆。假设模块A修改了一个业务逻辑，他需要告知所有业务线，自查项目中有没有用到模块A的这个业务，系统迭代速度被严重拖慢，且上线BUG频出。  

经过分析后发现，垂直拆分方式有这些缺陷：
- 各项目无法互调，仍然有部分对其他项目模块的代码编写，模块业务变更、数据表变更，影响会扩散到其他的服务
- 每个服务都是暴露到公网的，路由规则会比较复杂
- 因为都暴露到公网，所以认证、授权等每个项目都需要写一遍

于是调研后决定再次进行改造，引入“注册中心”，所有项目均要注册进来，以方便项目间通过内网调用。然后在内网出口侧架一个网关，用来暴露对外的接口，所有对外流量均经过网关，在这里可以做统一的权限处理。改造后的架构如下图所示：  

